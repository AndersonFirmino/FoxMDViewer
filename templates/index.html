{% extends "base.html" %}

{% block title %}MDViewer - {{ base_dir }}{% endblock %}

{% block content %}
<div class="index-container">
    <div class="search-box">
        <input 
            type="text" 
            id="search-input" 
            placeholder="ğŸ¦Š Buscar arquivos..."
            class="search-input"
        >
    </div>

    <div class="stats-bar">
        <span id="file-count">â›©ï¸ Carregando...</span>
        <span id="base-dir">ğŸ“ {{ base_dir }}</span>
    </div>

    <div id="file-tree" class="file-tree">
        <div class="loading">ğŸ¦Š *kitsune estÃ¡ buscando seus arquivos*</div>
    </div>
</div>

<style>
    .file-card {
        transition: all 0.3s ease;
    }
    .file-card:hover {
        transform: translateX(5px);
    }
    .file-card:hover .file-icon {
        animation: kitsune-wiggle 0.5s ease;
    }
    @keyframes kitsune-wiggle {
        0%, 100% { transform: rotate(0deg); }
        25% { transform: rotate(-10deg); }
        75% { transform: rotate(10deg); }
    }
    .directory-group {
        animation: fadeInUp 0.5s ease forwards;
        opacity: 0;
    }
    .directory-group:nth-child(1) { animation-delay: 0.1s; }
    .directory-group:nth-child(2) { animation-delay: 0.2s; }
    .directory-group:nth-child(3) { animation-delay: 0.3s; }
    .directory-group:nth-child(4) { animation-delay: 0.4s; }
    .directory-group:nth-child(5) { animation-delay: 0.5s; }
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .fox-trail {
        position: absolute;
        font-size: 0.6em;
        opacity: 0.3;
        pointer-events: none;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    const BASE_DIR = "{{ base_dir }}";
    const foxIcons = ['ğŸ¦Š', 'ğŸ¦Š', 'ğŸ¦Š', 'ğŸ“', 'ğŸ“œ', 'ğŸ“‹'];
    
    async function loadFiles() {
        try {
            const response = await fetch('/api/files');
            const data = await response.json();
            
            const fileTree = document.getElementById('file-tree');
            const fileCount = document.getElementById('file-count');
            
            fileCount.textContent = `â›©ï¸ ${data.total_count} pergaminhos encontrados`;
            
            if (data.files.length === 0) {
                fileTree.innerHTML = `
                    <div class="empty-state">
                        <p>ğŸ¦Š Nenhum pergaminho neste santuÃ¡rio</p>
                        <p class="hint">Crie arquivos markdown em ${escapeHtml(data.base_dir)}</p>
                    </div>
                `;
                return;
            }
            
            const grouped = groupFilesByDirectory(data.files);
            fileTree.innerHTML = renderFileTree(grouped);
            addEventListeners();
            
        } catch (error) {
            console.error('Error loading files:', error);
            document.getElementById('file-tree').innerHTML = `
                <div class="error-state">
                    <p>ğŸ¦Š Algo deu errado no reino espiritual</p>
                    <p class="hint">${error.message}</p>
                </div>
            `;
        }
    }
    
    function groupFilesByDirectory(files) {
        const grouped = {};
        
        files.forEach(file => {
            const parts = file.relative_path.split('/');
            const dir = parts.length > 1 ? parts.slice(0, -1).join('/') : '/';
            
            if (!grouped[dir]) {
                grouped[dir] = {
                    name: dir === '/' ? 'Raiz' : dir,
                    path: dir,
                    files: [],
                    count: 0
                };
            }
            
            grouped[dir].files.push(file);
            grouped[dir].count++;
        });
        
        const sorted = Object.values(grouped).sort((a, b) => {
            if (a.path === '/') return -1;
            if (b.path === '/') return 1;
            return a.path.localeCompare(b.path);
        });
        
        sorted.forEach(group => {
            group.files.sort((a, b) => a.filename.localeCompare(b.filename));
        });
        
        return sorted;
    }
    
    function renderFileTree(grouped) {
        return grouped.map(group => `
            <div class="directory-group" data-path="${escapeHtml(group.path)}">
                <div class="directory-header">
                    <span class="directory-name">${escapeHtml(group.name)}</span>
                    <span class="directory-count">${group.count} pergaminho${group.count !== 1 ? 's' : ''}</span>
                </div>
                <div class="directory-files">
                    ${group.files.map(file => renderFileCard(file)).join('')}
                </div>
            </div>
        `).join('');
    }
    
    function getFoxIcon(filename) {
        const name = filename.toLowerCase();
        if (name.includes('readme')) return 'ğŸ¦Š';
        if (name.includes('todo') || name.includes('task')) return 'ğŸ“‹';
        if (name.includes('guide') || name.includes('tutorial')) return 'ğŸ“œ';
        if (name.includes('api') || name.includes('doc')) return 'ğŸ“';
        return foxIcons[Math.floor(Math.random() * foxIcons.length)];
    }
    
    function renderFileCard(file) {
        const icon = getFoxIcon(file.filename);
        return `
            <a href="/viewer/${encodeURIComponent(file.relative_path)}" class="file-card" data-search="${escapeHtml(file.filename)} ${escapeHtml(file.title || '')} ${escapeHtml(file.preview || '')}">
                <div class="file-icon">${icon}</div>
                <div class="file-info">
                    <h3 class="file-title">${escapeHtml(file.title || file.filename)}</h3>
                    <p class="file-name">${escapeHtml(file.filename)}</p>
                    <div class="file-meta">
                        <span>ğŸ“… ${formatDate(file.modified_at)}</span>
                        <span>ğŸ“¦ ${formatSize(file.size)}</span>
                    </div>
                    ${file.preview ? `<p class="file-preview">${escapeHtml(file.preview)}</p>` : ''}
                </div>
            </a>
        `;
    }
    
    function addEventListeners() {
        document.querySelectorAll('.directory-header').forEach(header => {
            header.addEventListener('click', (e) => {
                const group = header.closest('.directory-group');
                group.classList.toggle('collapsed');
            });
        });
        
        document.getElementById('search-input').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            
            document.querySelectorAll('.file-card').forEach(card => {
                const searchText = card.dataset.search.toLowerCase();
                card.style.display = searchText.includes(query) ? 'flex' : 'none';
            });
            
            document.querySelectorAll('.directory-group').forEach(group => {
                const visibleFiles = group.querySelectorAll('.file-card[style="display: flex"], .file-card:not([style])');
                const hasVisible = Array.from(visibleFiles).some(f => f.style.display !== 'none');
                group.style.display = hasVisible || !query ? 'block' : 'none';
            });
        });

        document.querySelectorAll('.file-card').forEach(card => {
            card.addEventListener('mouseenter', function() {
                if (Math.random() > 0.9) {
                    showFoxTrail(this);
                }
            });
        });
    }
    
    function showFoxTrail(element) {
        const trail = document.createElement('span');
        trail.className = 'fox-trail';
        trail.textContent = 'âœ¨';
        trail.style.left = Math.random() * 100 + '%';
        trail.style.top = Math.random() * 100 + '%';
        element.style.position = 'relative';
        element.appendChild(trail);
        setTimeout(() => trail.remove(), 1000);
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString('pt-BR');
    }
    
    function formatSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }
    
    loadFiles();
</script>
{% endblock %}
